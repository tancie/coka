const fs = require("fs");
var request = require('superagent');
exports.checkLogin = async (ctx) => {  //api 文件夹，挂载api的对象
    let { login } = CONFIG
    // console.log(login)
    let config = {
        uri: login.sessionUrl || login.ssoUrl,
        method: login.sessionMethod,
        headers: login.sessionHeaders,
        form: Object.assign(login.sessionSign, { token: '2.0052efe3acc7dbe30843465d1edc2f6667' })

    }

    let checkLogin = () => {
        return new Promise((comlete) => request.post(config.uri)
            .send(config.form)
            .set(config.headers)
            .end(function (err, res) {
                // console.log(err, res)
                if (err) {
                    //do something
                } else {

                    ctx.user = login.checkLogin(res);
                    //do something
                }
                comlete();
            })
        )
    }
    let token = ctx.cookies.get(login.tokenName);

    if (!token) {
        return ctx.redirect('/login')
        // await checkLogin();
        // ctx.cookies.set(login.tokenName, '2.0052efe3acc7dbe30843465d1edc2f6667')
        // ctx.ajax({ a: '111' })
    }
    // return ctx.user = {}
    // function checkLogin() {

    // }
    await checkLogin()

    return ctx
}


