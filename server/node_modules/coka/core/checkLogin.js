const fs = require("fs");
var request = require('superagent');
exports.checkLogin = async (ctx) => {  //api 文件夹，挂载api的对象
    let { login } = CONFIG
    let token = ctx.cookies.get(login.tokenName);

    let config = {
        uri: login.sessionUrl || login.ssoUrl,
        method: login.sessionMethod,
        headers: login.sessionHeaders,
        form: Object.assign(login.sessionSign, { token})

    }

    let checkLogin = () => {

        return new Promise((comlete) => request.post(config.uri)
            .send(config.form)
            .set(config.headers)
            .end(function (err, res) {
                // console.log(err, res)
                if (err) {
                    //do something
                } else {
                    let loginStatus = login.checkLogin(res);
                    if (loginStatus) {
                        console.log(loginStatus.data)
                        ctx.user = null;//loginStatus.data
                        let tokenName = ctx.cookies.get(login.tokenName)
                        if (tokenName !== loginStatus) {
                            // ctx.cookies.set(login.tokenName, '2.0052efe3acc7dbe30843465d1edc2f6667')

                        }
                    }


                }
                comlete();
            })
        )
    }
   

    if (!token) {
        let ssoLogin = login.ssoUrl + login.ssoLogin+'?'+'service=http://beta.mp.lianjia.com:3400'
        return ctx.redirect(ssoLogin)
        // await checkLogin();
        // ctx.cookies.set(login.tokenName, '2.0052efe3acc7dbe30843465d1edc2f6667')
        // ctx.ajax({ a: '111' })
    }
    // return ctx.user = {}
    // function checkLogin() {

    // }
    await checkLogin()
    // if (!ctx.user) {
    //     return ctx.redirect('/login')
    // }

    return ctx.user
}


